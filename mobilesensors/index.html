<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StellarRoute Mobile IMU</title>

<style>
body {
  background:#0b0b0b;
  color:#e5e5e5;
  font-family:system-ui;
  padding:12px;
}
button {
  width:100%;
  padding:22px;
  font-size:1.6rem;
  margin:8px 0;
  border:none;
  border-radius:14px;
  font-weight:bold;
}
#permBtn { background:#2563eb; color:white; }
.btn-inc { background:#22c55e; }
.btn-dec { background:#ef4444; }
.val { color:#4ade80; font-weight:bold; }
</style>
</head>

<body>

<h2>üõ∞Ô∏è StellarRoute Mobile IMU</h2>

<button id="permBtn">ENABLE SENSORS</button>

<div>Status: <span id="status" class="val">DISCONNECTED</span></div>
<div>Heading: <span id="heading" class="val">0</span>¬∞</div>
<div>Gyro Œ±: <span id="ga" class="val">0</span></div>
<div>Gyro Œ≤: <span id="gb" class="val">0</span></div>
<div>Gyro Œ≥: <span id="gc" class="val">0</span></div>

<h2>SPEED: <span id="speedVal">0</span>%</h2>

<button class="btn-inc">‚¨Ü SPEED UP</button>
<button class="btn-dec">‚¨á SLOW DOWN</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

/* üî¥ USE REALTIME DATABASE CONFIG üî¥ */

const firebaseConfig = {
  apiKey: "AIzaSyDnpH_1zGTWHjEtvAO8qgPEydHiNpsjA1U",
  authDomain: "stellarroute-65138.firebaseapp.com",
  databaseURL: "https://stellarroute-65138-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "stellarroute-65138",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const vehicleRef = ref(db, "vehicle_control");

/* STATE */
let state = {
  speed: 0,
  heading: 0,
  accel: { x:0, y:0, z:0 },
  gyro: { alpha:0, beta:0, gamma:0 }
};

const statusEl = document.getElementById("status");
const headingEl = document.getElementById("heading");
const ga = document.getElementById("ga");
const gb = document.getElementById("gb");
const gc = document.getElementById("gc");
const speedVal = document.getElementById("speedVal");

document.getElementById("permBtn").onclick = async () => {
  if (DeviceMotionEvent?.requestPermission) {
    await DeviceMotionEvent.requestPermission();
    await DeviceOrientationEvent.requestPermission();
  }
  startSensors();
};

function startSensors() {
  statusEl.innerText = "ACTIVE";

  window.addEventListener("deviceorientation", e => {
    state.gyro = {
      alpha: +(e.alpha || 0).toFixed(2),
      beta: +(e.beta || 0).toFixed(2),
      gamma: +(e.gamma || 0).toFixed(2)
    };
    state.heading = e.webkitCompassHeading
      ? Math.round(e.webkitCompassHeading)
      : Math.round(360 - (e.alpha || 0));

    headingEl.innerText = state.heading;
    ga.innerText = state.gyro.alpha;
    gb.innerText = state.gyro.beta;
    gc.innerText = state.gyro.gamma;
  });

  window.addEventListener("devicemotion", e => {
    if (e.accelerationIncludingGravity) {
      state.accel = {
        x:+(e.accelerationIncludingGravity.x || 0).toFixed(2),
        y:+(e.accelerationIncludingGravity.y || 0).toFixed(2),
        z:+(e.accelerationIncludingGravity.z || 0).toFixed(2)
      };
    }
  });

  setInterval(syncFirebase, 200); // 5Hz
}

document.querySelector(".btn-inc").onclick = () => updateSpeed(10);
document.querySelector(".btn-dec").onclick = () => updateSpeed(-10);

function updateSpeed(v) {
  state.speed = Math.max(0, Math.min(100, state.speed + v));
  speedVal.innerText = state.speed;
}

function syncFirebase() {
  set(vehicleRef, {
    speed: state.speed,
    heading: state.heading,
    accel: state.accel,
    gyro: state.gyro,
    timestamp: Date.now()
  });
}
</script>

</body>
</html>
